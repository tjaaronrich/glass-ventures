require("dotenv").config();
const express = require("express"),
  app = express(),
  cors = require("cors"),
  { SERVER_PORT, MYHOST, DATABASE, USER, PASSWORD } = process.env,
  mysql = require("mysql"),
  db_config = {
    host: MYHOST,
    database: DATABASE,
    user: USER,
    password: PASSWORD
,
  };

app.use(express.json());
app.use(cors());

app.use(express.static(`${__dirname}/../build`));

var connection;
function handleDisconnect() {
  connection = mysql.createConnection(db_config);

  connection.connect(function (err) {
    if (err) {
      console.error("Error connecting: " + err.stack);
      return;
    }

    console.log("Connected as id " + connection.threadId);
  });

  connection.on("error", function (err) {
    console.log("db error", err);
    if (err.code === "PROTOCOL_CONNECTION_LOST") {
      handleDisconnect();
    } else {
      throw err;
    }
  });
}
handleDisconnect();

app.post("/api/content", (req, res) => {
  console.log(req);
  res.status(200).send(response);
});

app.get("/api/content/:ftbNum", (req, res) => {
  console.log("axios request fired", req.params.ftbNum);

  connection.query(
    `SELECT * FROM tblftb WHERE ftbNum='${req.params.ftbNum}'`,
    function (error, results, fields) {
      if (error) throw error;

      results.forEach((result) => {
        console.log("result.content: ", result);

        res.status(200).send(result.content);
      });
    }
  );
});

app.put("/api/update/content", (req, res) => {
  console.log(req);
  console.log("ftbNum: ", req.body.ftbNum);
  console.log("combinedHtml: ", req.body.combinedHtml);

  connection.query(
    `
    UPDATE tblftb 
    SET content='${req.body.combinedHtml}'
    WHERE ftbNum='${req.body.ftbNum}'
    `,
    function (error, results, fields) {
      if (error) throw error;

      res.status(200).send("Update Successful!");
    }
  );
});

app.delete("/api/", (req, res) => {
  console.log(req);
  res.status(200).send(response);
});

app.listen(SERVER_PORT, () =>
  console.log(`Server is running on port ${SERVER_PORT}.`)
);
